/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var I=Object.defineProperty;var A=Object.getOwnPropertyDescriptor;var D=Object.getOwnPropertyNames;var B=Object.prototype.hasOwnProperty;var N=(o,e)=>{for(var t in e)I(o,t,{get:e[t],enumerable:!0})},S=(o,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of D(e))!B.call(o,i)&&i!==t&&I(o,i,{get:()=>e[i],enumerable:!(n=A(e,i))||n.enumerable});return o};var U=o=>S(I({},"__esModule",{value:!0}),o);var H={};N(H,{default:()=>y});module.exports=U(H);var l=require("obsidian");var h=require("obsidian"),f={loadImageBlob:5e3,longTap:500,deleteTempFile:6e4,openPdfMenu:5e3,successNotice:1800};function R(o,e){let t=new Promise((n,i)=>setTimeout(()=>i(`timed out after ${o} ms`),o));return Promise.race([e,t])}async function W(o){let e=o instanceof ArrayBuffer?new Blob([o],{type:"image/png"}):await b(o);try{let t=new ClipboardItem({[e.type]:e});await navigator.clipboard.write([t]),new h.Notice("Image copied to the clipboard!",f.successNotice)}catch(t){console.error(t),new h.Notice("Error, could not copy the image!")}}async function b(o){let e=()=>new Promise((t,n)=>{let i=new Image;i.crossOrigin="anonymous",i.onload=()=>{let a=document.createElement("canvas");a.width=i.width,a.height=i.height,a.getContext("2d").drawImage(i,0,0),a.toBlob(s=>{t(s)})},i.onerror=async()=>{try{await fetch(i.src,{mode:"no-cors"});let a=await b(`https://api.allorigins.win/raw?url=${encodeURIComponent(o)}`);t(a)}catch(a){n()}},i.src=o});return R(f.loadImageBlob,e())}function d(o,e,t,n,i){return o.on(e,t,n,i),()=>o.off(e,t,n,i)}function M(o){let e=o.target;if(!(e instanceof HTMLImageElement))console.error("imageElement is supposed to be a HTMLImageElement. imageElement:",e);else return e}function P(o,e){let n=e.vault.adapter.getFilePath("").replace("file://",""),i=o.pathname;if(i.startsWith(n)){let a=i.substring(n.length+1);return decodeURI(a)}}function E(o,e){o.workspace.getLeaf(!0).openFile(e,{active:!0})}function k(o,e){let t=M(e);if(!t)return;let n=o.workspace.getActiveFile(),i=P(new URL(t.src),o);if(!i)return;let a=n?o.metadataCache.getFirstLinkpathDest(i,n.path):o.vault.getAbstractFileByPath(i);a&&a instanceof h.TFile&&E(o,a)}function x(o){let e=activeDocument;o.register(d(e,"keydown","*",t=>{t.key==="Escape"&&(t.preventDefault(),t.stopPropagation(),o.hide())}))}function m(o,e,t){let n={"copy-to-clipboard":{section:"info",icon:"image-file",title:"interface.label-copy"},"open-in-new-tab":{section:"open",icon:"file-plus",title:"interface.menu.open-in-new-tab"},"open-in-default-app":{section:"system",icon:"arrow-up-right",title:"plugins.open-with-default-app.action-open-file"},"show-in-explorer":{section:"system",icon:"arrow-up-right",title:"plugins.open-with-default-app.action-show-in-folder"+(h.Platform.isMacOS?"-mac":"")},"reveal-in-navigation":{section:"system",icon:"folder",title:"plugins.file-explorer.action-reveal-file"},"open-pdf":{section:"system",icon:"arrow-up-right",title:"plugins.open-with-default-app.action-open-file"}};return e==="copy-to-clipboard"&&t&&o.onClick(async()=>{await W(typeof t=="string"?t:await t)}),o.setIcon(n[e].icon).setTitle(i18next.t(n[e].title)).setSection(n[e].section)}var v=require("obsidian"),L={pdfMenu:!1,middleClickNewTab:!0,enableDefaultOnCanvas:!1},T=class extends v.PluginSettingTab{constructor(e,t){super(e,t),this.plugin=t}display(){let{containerEl:e}=this;e.empty(),e.createEl("h3",{text:"Image Context Menus settings"}),new v.Setting(e).setName("PDF context menu").addToggle(t=>{t.setValue(this.plugin.settings.pdfMenu).onChange(n=>{this.plugin.settings.pdfMenu=n,this.plugin.saveSettings()})}),new v.Setting(e).setName("Middle mouse click on image link to open in new tab").addToggle(t=>{t.setValue(this.plugin.settings.middleClickNewTab).onChange(n=>{this.plugin.settings.middleClickNewTab=n,this.plugin.saveSettings()})}),new v.Setting(e).setName("Enable regular context menu on canvas").setDesc(`The regular context menu sometimes duplicates the context menu on the canvas, so it's disabled there by default.
There is a separate context menu for images directly on the canvas, but if that's not enough (for example for images in notes on canvas), you can enable the regular context menu here too.`).addToggle(t=>{t.setValue(this.plugin.settings.enableDefaultOnCanvas).onChange(n=>{this.plugin.settings.enableDefaultOnCanvas=n,this.plugin.saveSettings()})})}};var y=class extends l.Plugin{async loadSettings(){this.settings=Object.assign({},L,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async onload(){await this.loadSettings(),this.addSettingTab(new T(this.app,this)),this.registerDocument(document);let e=/(avif|bmp|gif|jpe?g|png|svg|webp)$/gi;this.app.workspace.on("window-open",(t,n)=>{this.registerDocument(n.document)}),this.registerEvent(this.app.workspace.on("file-menu",(t,n,i)=>{i==="canvas-menu"&&n instanceof l.TFile&&(n.extension.match(e)||n.extension==="pdf")&&(t.addItem(a=>m(a,"open-in-new-tab").onClick(()=>{E(this.app,n)})),t.addItem(a=>m(a,"copy-to-clipboard",this.app.vault.readBinary(n))))})),this.registerEvent(this.app.workspace.on("canvas:node-menu",(t,n)=>{var i,a;if(((i=n.unknownData)==null?void 0:i.type)==="link"){let u=(a=n.unknownData)==null?void 0:a.url;t.addItem(s=>m(s,"copy-to-clipboard",u).setSection("canvas"))}})),this.registerEvent(this.app.workspace.on("url-menu",(t,n)=>{n.match(e)&&t.addItem(i=>m(i,"copy-to-clipboard",n))}))}registerDocument(e){this.register(d(e,"mouseover",".pdf-embed iframe, .pdf-embed div.pdf-container, .workspace-leaf-content[data-type=pdf]",this.showOpenPdfMenu.bind(this))),this.register(d(e,"mousemove",".pdf-canvas",this.showOpenPdfMenu.bind(this))),l.Platform.isDesktop?(this.register(d(e,"contextmenu","img",this.onImageContextMenu.bind(this))),this.register(d(e,"mouseup","img",this.onImageMouseUp.bind(this))),this.register(d(e,"mouseover",".cm-link, .cm-hmd-internal-link",this.storeLastHoveredLinkInEditor.bind(this))),this.register(d(e,"mouseover","a.internal-link",this.storeLastHoveredLinkInPreview.bind(this)))):(this.register(d(e,"touchstart","img",this.startWaitingForLongTap.bind(this))),this.register(d(e,"touchend","img",this.stopWaitingForLongTap.bind(this))),this.register(d(e,"touchmove","img",this.stopWaitingForLongTap.bind(this))))}storeLastHoveredLinkInEditor(e){var a;let t=(a=this.app.workspace.getActiveViewOfType(l.MarkdownView))==null?void 0:a.editor;if(!t)return;let n=t.posAtMouse(e),i=t.getClickableTokenAt(n);i&&(this.lastHoveredLinkTarget=i.text)}storeLastHoveredLinkInPreview(e,t){this.lastHoveredLinkTarget=t.getAttribute("data-href")}showOpenPdfMenu(e,t){var g,w;if(!this.settings.pdfMenu||this.openPdfMenu||this.preventReopenPdfMenu)return;let n=((g=this.app.workspace.getActiveFile())==null?void 0:g.extension)==="canvas";if(!this.settings.enableDefaultOnCanvas&&n)return;let i=t.getBoundingClientRect(),a=100;if(!n&&i.left+a<e.x&&e.x<i.right-a&&i.top+a<e.y&&e.y<i.bottom-a)return;let u=t.closest(".pdf-embed");if((u==null?void 0:u.className)==="canvas-node-content pdf-embed is-loaded")return;let s;if(u){let r;u.hasClass("popover")?r=this.lastHoveredLinkTarget:r=(w=u.getAttr("src"))!=null?w:this.lastHoveredLinkTarget,r=r==null?void 0:r.replace(/#page=\d+$/,"");let c=this.app.workspace.getActiveFile().path;s=this.app.metadataCache.getFirstLinkpathDest(r,c)}else s=this.app.workspace.getActiveFile();if(n){let r=activeDocument.querySelector(".menu");r&&(r.style.display="none",this.canvasCardMenu=r)}let p=new l.Menu;x(p),p.onHide(()=>this.openPdfMenu=void 0),p.addItem(r=>m(r,"open-pdf").onClick(async()=>{this.preventReopenPdfMenu=!0,setTimeout(()=>{this.preventReopenPdfMenu=!1},f.openPdfMenu),this.hideOpenPdfMenu(),l.Platform.isDesktop?this.app.openWithDefaultApp(s.path):await this.app.vault.adapter.open(s.path)})),p.showAtMouseEvent(e),this.openPdfMenu=p,setTimeout(this.hideOpenPdfMenu.bind(this),f.openPdfMenu)}hideOpenPdfMenu(){this.openPdfMenu&&this.openPdfMenu.hide(),this.canvasCardMenu&&(this.canvasCardMenu.style.display="")}startWaitingForLongTap(e,t){this.longTapTimeoutId?(clearTimeout(this.longTapTimeoutId),this.longTapTimeoutId=void 0):e.targetTouches.length==1&&(this.longTapTimeoutId=window.setTimeout(this.processLongTap.bind(this,e,t),f.longTap))}stopWaitingForLongTap(){this.longTapTimeoutId&&(clearTimeout(this.longTapTimeoutId),this.longTapTimeoutId=void 0)}async processLongTap(e,t){e.stopPropagation(),this.longTapTimeoutId=void 0;let n=this.app.vault.adapter,i=window,a=n.getFullPath(""),s=i.WEBVIEW_SERVER_URL+"/_capacitor_file_"+a;if(t.src.startsWith(s)){let p=t.src.replace(s,""),g=decodeURIComponent(p);await n.open(g)}else try{let p=await b(t.src);if(!p.type.startsWith("image/")){new l.Notice(`Unsupported mime type ${p.type}`);return}let g=p.type.replace("image/",""),r=`/.temp-${window.URL.createObjectURL(new Blob([])).split("/").pop()}.${g}`,c=await p.arrayBuffer();await n.writeBinary(r,c),setTimeout(()=>n.remove(r),f.deleteTempFile),new l.Notice("Image was temporarily saved and will be removed in 1 minute"),await n.open(r)}catch(p){new l.Notice("Cannot open image")}}onImageContextMenu(e){var g,w,r;let t=M(e);if(!t||!this.settings.enableDefaultOnCanvas&&((g=this.app.workspace.getActiveFile())==null?void 0:g.extension)==="canvas"||((r=(w=e.targetNode)==null?void 0:w.parentElement)==null?void 0:r.className)==="canvas-node-content media-embed image-embed is-loaded")return;let n=t.currentSrc,i=new URL(n),a=i.protocol;if(!["app:","data:","http:","https:"].includes(a)){new l.Notice(`no handler for ${a} protocol`);return}e.preventDefault();let s=new l.Menu,p=P(i,this.app);s.addSections(["open","info","system"]),a==="app:"&&p&&(s.addItem(c=>m(c,"open-in-new-tab").onClick(()=>{k(this.app,e)})),l.Platform.isDesktop&&(s.addItem(c=>m(c,"open-in-default-app").onClick(()=>this.app.openWithDefaultApp(p))),s.addItem(c=>m(c,"show-in-explorer").onClick(()=>{this.app.showInFolder(p)})),s.addItem(c=>m(c,"reveal-in-navigation").onClick(()=>{var F;let C=this.app.vault.getFileByPath(p);if(!C){console.warn(`getFileByPath returned null for ${p}`);return}(F=this.app.internalPlugins.getEnabledPluginById("file-explorer"))==null||F.revealInFolder(C)})))),s.addItem(c=>m(c,"copy-to-clipboard",n)),x(s),s.showAtPosition({x:e.pageX,y:e.pageY}),this.app.workspace.trigger("copy-url-in-preview:contextmenu",s)}onImageMouseUp(e){e.button==1&&this.settings.middleClickNewTab&&k(this.app,e)}};
